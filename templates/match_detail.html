{% extends "base.html" %}

{% block body %}
<script type="application/javascript">

	$(document).ready(function () {
		const map_name = "{{ telemetry_data.match_map_name }}"

		const telem_data = [
			{%- for telemetry in telemetry_data.events -%}
				['{{- telemetry.timestamp }}', '{{ telemetry.event|safe -}}'],
			{%- endfor -%}
		];

		const x_y_co_ords = [
			{%- for telemetry in telemetry_data.events -%}
				{%- if telemetry.x_cord -%}
					{
						x: '{{- telemetry.x_cord -}}',
						y: '{{- telemetry.y_cord -}}',
						id: 'telem_{{- loop.index -}}'
					},
				{%- endif -%}
			{%- endfor -%}
		];
        
        const roster_data = [
            {%- for roster in telemetry_data.rosters -%}
				['{{- roster.roster_rank -}}', '{{- roster.participant_objects|safe -}}'],
			{%- endfor -%}
		];
		
		$('#telemetry_datatable_datatable').DataTable({
			data: telem_data,
			pageLength: 5,
			order: [[0, "asc"]],
			scrollY: "400px",
			scrollCollapse: true,
			paging: false,
			bFilter: true,
			bSort: true,
			bLengthChange: true,
		});

        $('#rosters_datatable').DataTable({
			data: roster_data,
			pageLength: 5,
			order: [[0, "asc"]],
			scrollY: "200px",
			scrollCollapse: true,
			paging: false,
			bFilter: true,
			bSort: true,
			bLengthChange: true,
		});

		function Circle(options){
            this.x = options.x;
            this.y = options.y;
            this.fill = options.fill;
            this.radius = options.radius
            this.id = options.id

            this.draw = function(this_scale, context){
				context.fillStyle = this.fill;
				context.lineWidth = 0.1;
                context.beginPath();
                context.arc(this.x / this_scale, this.y / this_scale,  this.radius, 0, 2 * Math.PI, true);
                context.fill();
                context.stroke();
            }
        }

        function map_scale(size){
            switch(map_name){
                case 'Erangel': return Math.floor(816000 / size);
                case 'Miramar': return Math.floor(816000 / size);
                case 'Sanhok': return Math.floor(408000 / size);
                case 'Camp Jackal': return Math.floor(204000 / size);
                case 'Karakin': return Math.floor(204000 / size);
                case 'Vikendi': return Math.floor(612000 / size);
            }
        }

		const markers = []

		create_circles = function(){

			x_y_co_ords.forEach(function (item) {
				markers.push(new Circle({
					x: item.x,
					y: item.y,
					fill: 'red',
					radius: 0.5,
					id: item.id
				}))
			});

		}

		create_circles()

		function intersects(x, y, cx, cy, r) {
			var dx = x - cx
			var dy = y - cy
			return dx * dx + dy * dy <= r * r
		}

		var canvas = document.getElementById('map_canvas')

		var image = new Image();
		image.src = "{{ telemetry_data.map_image }}";
		map_container_width = $('#map_container')[0]
		
		image.width = map_container_width.offsetWidth
		image.height = map_container_width.offsetWidth
		canvas.width = image.width;
		canvas.height = image.height;

		var ctx = canvas.getContext('2d');
		trackTransforms(ctx);

		function redraw() {

			// Clear the entire canvas
			var p1 = ctx.transformedPoint(0, 0);
			var p2 = ctx.transformedPoint(canvas.width, canvas.height);
			ctx.clearRect(p1.x, p1.y, p2.x - p1.x, p2.y - p1.y);
			ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
			ctx.fillStyle = "rgb(255, 255, 255, 0)";
            this_scale = map_scale(image.width)
            markers.forEach(function (marker) {
            	marker.draw(this_scale, ctx);
            });

		}
		redraw();

		var lastX = canvas.width / 2, lastY = canvas.height / 2;

		var dragStart, dragged;

		canvas.addEventListener('mousedown', function (evt) {
			document.body.style.mozUserSelect = document.body.style.webkitUserSelect = document.body.style.userSelect = 'none';
			lastX = evt.offsetX || (evt.pageX - canvas.offsetLeft);
			lastY = evt.offsetY || (evt.pageY - canvas.offsetTop);
			dragStart = ctx.transformedPoint(lastX, lastY);
			dragged = false;
		}, false);

		canvas.addEventListener('mousemove', function (evt) {
			lastX = evt.offsetX || (evt.pageX - canvas.offsetLeft);
			lastY = evt.offsetY || (evt.pageY - canvas.offsetTop);
			dragged = true;
			if (dragStart) {
				var pt = ctx.transformedPoint(lastX, lastY);
				ctx.translate(pt.x - dragStart.x, pt.y - dragStart.y);
				redraw();
			}
		}, false);

		canvas.addEventListener('mouseup', function (evt) {
			dragStart = null;

			if(evt.altKey){
				lastX = evt.offsetX || (evt.pageX - canvas.offsetLeft);
				lastY = evt.offsetY || (evt.pageY - canvas.offsetTop);
				var pt = ctx.transformedPoint(lastX, lastY);
				x = pt.x
				y = pt.y

				this_scale = map_scale(ctx.canvas.width)

				markers.forEach(function (item) {

					item_x = item.x / this_scale
					item_y = item.y / this_scale

					if (intersects(x, y, item_x, item_y, item.radius)) {
						$(`#${item.id}`).css({ 'top': evt.pageY - 60, 'left': x, 'position': 'absolute', 'border': '1px solid black', 'padding': '5px' });
						$(`#${item.id}`).show();
					} else {
						$(`#${item.id}`).hide();
					}

				});
			} else {
				if (!dragged) zoom(evt.shiftKey ? -1 : 1);
			}
		}, false);

		var scaleFactor = 1.1;

		var zoom = function (clicks) {
			var pt = ctx.transformedPoint(lastX, lastY);
			ctx.translate(pt.x, pt.y);
			var factor = Math.pow(scaleFactor, clicks);
			ctx.scale(factor, factor);
			ctx.translate(-pt.x, -pt.y);
			redraw();
		}

		var handleScroll = function (evt) {
			var delta = evt.wheelDelta ? evt.wheelDelta / 40 : evt.detail ? -evt.detail : 0;
			if (delta) zoom(delta);
			return evt.preventDefault() && false;
		};

		canvas.addEventListener('DOMMouseScroll', handleScroll, false);
		canvas.addEventListener('mousewheel', handleScroll, false);

		// Adds ctx.getTransform() - returns an SVGMatrix
		// Adds ctx.transformedPoint(x,y) - returns an SVGPoint
		function trackTransforms(ctx) {
			var svg = document.createElementNS("http://www.w3.org/2000/svg", 'svg');
			var xform = svg.createSVGMatrix();
			ctx.getTransform = function () { return xform; };

			var savedTransforms = [];
			var save = ctx.save;
			ctx.save = function () {
				savedTransforms.push(xform.translate(0, 0));
				return save.call(ctx);
			};

			var restore = ctx.restore;
			ctx.restore = function () {
				xform = savedTransforms.pop();
				return restore.call(ctx);
			};

			var scale = ctx.scale;
			ctx.scale = function (sx, sy) {
				xform = xform.scaleNonUniform(sx, sy);
				return scale.call(ctx, sx, sy);
			};

			var rotate = ctx.rotate;
			ctx.rotate = function (radians) {
				xform = xform.rotate(radians * 180 / Math.PI);
				return rotate.call(ctx, radians);
			};

			var translate = ctx.translate;
			ctx.translate = function (dx, dy) {
				xform = xform.translate(dx, dy);
				return translate.call(ctx, dx, dy);
			};

			var transform = ctx.transform;
			ctx.transform = function (a, b, c, d, e, f) {
				var m2 = svg.createSVGMatrix();
				m2.a = a; m2.b = b; m2.c = c; m2.d = d; m2.e = e; m2.f = f;
				xform = xform.multiply(m2);
				return transform.call(ctx, a, b, c, d, e, f);
			};

			var setTransform = ctx.setTransform;
			ctx.setTransform = function (a, b, c, d, e, f) {
				xform.a = a;
				xform.b = b;
				xform.c = c;
				xform.d = d;
				xform.e = e;
				xform.f = f;
				return setTransform.call(ctx, a, b, c, d, e, f);
			};

			var pt = svg.createSVGPoint();
			ctx.transformedPoint = function (x, y) {
				pt.x = x; pt.y = y;
				return pt.matrixTransform(xform.inverse());
			}
		}

	});

</script>

<div class="container" style='max-width: 1080px'>

	<div class='row'>

		<div class="col-md-6">
			<div class="card" id='match_detail_container'>
				<div class="card-header" style='text-align: center'>
					Match Details
				</div>
				<div class="card-body" style='height: max-content;' id='match_detail_container_body'>
					<div class="list-group d-flex flex-row flex-wrap">
						<p class="list-group-item text-center" style='width: 50%;'>
							Match ID:<br>{{ telemetry_data.match_id }}
						</p>
						<p class="list-group-item text-center" style='width: 50%;'>
							Match Map:<br>{{ telemetry_data.match_map_name }}
						</p>
					</div>
					<div class="list-group d-flex flex-row flex-wrap">
						<p class="list-group-item text-center" style='width: 50%;'>
							Your Kills: <br>{{ telemetry_data.player_kills }}
						</p>
						<p class="list-group-item text-center" style='width: 50%;'>
							Match elapsed time: <br>{{ telemetry_data.match_elapsed_time }}
						</p>
					</div>
					<div class="list-group d-flex flex-row flex-wrap">
						<p class="list-group-item text-center" style='width: 100%;'>
							Heals/Boosts used: <br>{{ telemetry_data.match_heals_used }}
						</p>
					</div>
					<div class="list-group d-flex flex-row flex-wrap" style='width: 100%' id='map_container'>
						<canvas id="map_canvas" width="100%"></canvas>
						{%- for telemetry in telemetry_data.events -%}
                            {%- if telemetry.x_cord -%}
                                <div class="card mb-3" id='telem_{{- loop.index -}}' style="max-width: 18rem; display: none;">
                                    <div class="card-header">
                                        {{ telemetry.timestamp }}
                                    </div>
                                    <div class="card-body">
                                        {{ telemetry.event|safe -}}
                                    </div>
                                </div>
                            {%- endif -%}
						{%- endfor -%}
					</div>
				</div>
            </div>
		</div>

		<div class="col-md-6" style='height: 150px'>
			<div class="card" id='telemetry_datatable_container'>
				<div class="card-header" style='text-align: center'>
					Match events
				</div>
				<div class="card-body">
					<table class='table table-condensed hover' id='telemetry_datatable_datatable' style="width:100%;">
						<thead>
							<tr>
								<th width='30%'>Timestamp</th>
								<th width='70%'>Event</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
            <br>
            <div class="card">
				<div class="card-header" style='text-align: center'>
					Leaderboard
				</div>
				<div class='card-body'>
					<table class='table table-condensed hover' id='rosters_datatable' style='width: 100%'>
						<thead>
							<tr>
								<th width='20%%'>Rank</th>
								<th width='80%'>Team Details</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
            </div>
            <br><br>
		</div>

	</div>

</div>

{% endblock %}